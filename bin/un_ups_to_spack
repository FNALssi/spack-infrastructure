#!/bin/sh

if [ x$SPACK_ROOT = x ]
then
    echo "This script requires \$SPACK_ROOT to be set , please source a"
    echo "spack setup-env.sh script first."
    exit 1
fi

#uninstall spack packages in ups_to_spack namespace
spack find --long -N | 
    grep ' ups_to_spack\.' | 
    while read hash p
    do 
        spack uninstall -y --dependents $p/$hash
    done

# clean out module files
find $SPACK_ROOT/share/spack/modules $SPACK_ROOT/share/spack/lmod -type f -print | 
  xargs egrep -l '(generated|created).by.*ups_to_spack' |
  xargs rm -f

# remove hash cache

cd $SPACK_ROOT
echo "in $PWD"
rm var/ups_to_spack.cache
rm -rf  var/spack/repos/ups_to_spack/packages/*

spack reindex
